@using ItemzApp.WebUI.Client.Services.ItemzTrace
@using ItemzApp.WebUI.Client.SharedModels
@inject NavigationManager NavManager

<h5>Traceability Component</h5>
<br />
<MudPaper Class="pa-4 align-start d-flex" Style="width: auto" Outlined="false">
	<MudText Typo="Typo.h6" Align="Align.Left">Parent / From Traces </MudText>
	<MudSpacer />
	<MudButton @onclick="async _ => await createParentTrace(ItemzId)" Variant="Variant.Filled" Size="Size.Medium" Color="Color.Primary"> Create Parent Trace </MudButton>
</MudPaper>
<MudDataGrid Items="@AllParentItemzTraces"
			 Filterable="true"
			 SortMode="@SortMode.None"
			 Groupable="false"
			 Striped="true"
			 FixedHeader="true"
			 HeaderClass="background-color: red;">
	<Columns>
		<PropertyColumn Property="x => x.ItemzID" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<TemplateColumn CellClass="d-flex justify-left">
			<CellTemplate>
				<MudButton Size="@Size.Large"
						   Variant="@Variant.Filled" Color="@Color.Success"
						   OnClick="_ => openItemz(context.Item.ItemzID.ToString())"> Open </MudButton>
						   <MudSpacer />
				<MudButton Size="@Size.Large"
						   Variant="@Variant.Filled" Color="@Color.Error"
						   OnClick="_ => deleteParentItemzTrace(context.Item.ItemzID,ItemzId)"> Delete </MudButton>
			</CellTemplate>
		</TemplateColumn>
	</Columns>
</MudDataGrid>
<MudPaper Class="pa-4 align-start d-flex" Style="width: auto" Outlined="false">
	<MudText Typo="Typo.h6" Align="Align.Left">Child / To Traces </MudText>
	<MudSpacer />
	<MudButton @onclick="async _ => await createChildTrace(ItemzId)" Variant="Variant.Filled" Size="Size.Medium" Color="Color.Primary"> Create Child Trace </MudButton>
</MudPaper>
<MudDataGrid Items="@AllChildItemzTraces"
			 Filterable="true"
			 SortMode="@SortMode.None"
			 Groupable="false"
			 Striped="true"
			 FixedHeader="true"
			 HeaderClass="background-color: red;">
	<Columns>
		<PropertyColumn Property="x => x.ItemzID" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
		<TemplateColumn CellClass="d-flex justify-left">
			<CellTemplate>
				<MudButton Size="@Size.Large"
						   Variant="@Variant.Filled" Color="@Color.Success"
						   OnClick="_ => openItemz(context.Item.ItemzID.ToString())"> Open </MudButton>
			</CellTemplate>
		</TemplateColumn>
	</Columns>
</MudDataGrid>

@code {
	[Parameter]
	public Guid ItemzId { get; set; }

	[Inject]
	public IItemzTraceService ItemzTraceService { get; set; }

	private ItemzParentAndChildTraceDTO SingleItemzTraces { get; set; } = new ItemzParentAndChildTraceDTO();
	private List<ParentTraceItemz__DTO> AllParentItemzTraces { get; set; } = new List<ParentTraceItemz__DTO>();
	private List<ChildTraceItemz__DTO> AllChildItemzTraces { get; set; } = new List<ChildTraceItemz__DTO>();


	protected override async Task OnInitializedAsync()
	{
		var SingleItemzTraces = await ItemzTraceService.__GET_All_Parent_and_Child_Itemz_Traces_By_ItemzID__Async(ItemzId);

		if (SingleItemzTraces != null)
		{
			if (SingleItemzTraces.Itemz != null)
			{
				if (SingleItemzTraces.Itemz.ParentItemz != null)
				{
					AllParentItemzTraces = SingleItemzTraces.Itemz.ParentItemz;
				}
				if (SingleItemzTraces.Itemz.ChildItemz != null)
				{
					AllChildItemzTraces = SingleItemzTraces.Itemz.ChildItemz;
				}
			}
		}
		StateHasChanged();
	}

	// protected override async Task OnAfterRenderAsync(bool firstRender)
	// {
	// 	if (firstRender)
	// 	{
	// 		var SingleItemzTraces = await ItemzTraceService.__GET_All_Parent_and_Child_Itemz_Traces_By_ItemzID__Async(ItemzId);

	// 		if (SingleItemzTraces != null)
	// 		{
	// 			if (SingleItemzTraces.Itemz != null)
	// 			{
	// 				if (SingleItemzTraces.Itemz.ParentItemz != null)
	// 				{
	// 					AllParentItemzTraces = SingleItemzTraces.Itemz.ParentItemz;
	// 				}
	// 				if (SingleItemzTraces.Itemz.ChildItemz != null)
	// 				{
	// 					AllChildItemzTraces = SingleItemzTraces.Itemz.ChildItemz;
	// 				}
	// 			}
	// 		}

	// 	}
	// }
	public async Task openItemz(string itemzId)
	{
		NavManager.NavigateTo($"/itemzDetails/{itemzId}", true);
	}
	public async Task deleteParentItemzTrace(Guid fromTraceItemzId, Guid toTraceItemzId)
	{
		try
		{
			ItemzTraceDTO tempDeleteItemzTraceDTO = new ItemzTraceDTO();
			tempDeleteItemzTraceDTO.FromTraceItemzId = fromTraceItemzId;
			tempDeleteItemzTraceDTO.ToTraceItemzId = toTraceItemzId;
			await ItemzTraceService.__DELETE_Itemz_Trace__Async(tempDeleteItemzTraceDTO);

			var itemToRemove = AllParentItemzTraces.FirstOrDefault(item => item.ItemzID == fromTraceItemzId); // Example condition
			if (itemToRemove != null)
			{
				AllParentItemzTraces.Remove(itemToRemove);
			}
			// ParentTraceItemz__DTO tempParentTraceItemz__DTO = new ParentTraceItemz__DTO();
			// tempParentTraceItemz__DTO.ItemzID = fromTraceItemzId;
			// AllParentItemzTraces.Remove(tempParentTraceItemz__DTO);
			//StateHasChanged();
		}
		catch
		{
			throw new NotImplementedException();
		}
	}



	public async Task createParentTrace(Guid ItemzId)
	{
		throw new NotImplementedException();
	}

	public async Task createChildTrace(Guid ItemzId)
	{
		throw new NotImplementedException();
	}

}
