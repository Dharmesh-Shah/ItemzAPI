@page "/itemz/{ItemzId:guid}"
@using ItemzApp.WebUI.Client.Services.Hierarchy
@using ItemzApp.WebUI.Client.Services.Itemz
@using ItemzApp.WebUI.Client.Services.ItemzTypeItemzsService
@using ItemzApp.WebUI.Client.SharedModels
@using Microsoft.AspNetCore.Components.Forms
@inject NavigationManager NavManager
@inject IDialogService DialogService

<MudPaper Class="pa-1 mb-5 align-start d-flex" Style="width: auto" Outlined="false">
<MudBreadcrumbs Items="_localBreadcrumbs" MaxItems="5">
	<SeparatorTemplate>
		<MudIcon Icon="@Icons.Material.Filled.KeyboardDoubleArrowRight" Size="Size.Medium" />
	</SeparatorTemplate>
	<ItemTemplate Context="item">
		<div style="display: flex; align-items: center;">
			@* // TO SHOW MUDICON AND MUDLINK TOGETHER ON THE SAME LINE! *@
			<MudIcon Icon=@item.Icon Color="Color.Primary"></MudIcon>
			<MudTooltip Text="@item.Text">
				<MudLink Href="@item.Href" OnClick="@(e => ForceReload(e, item.Href))" Typo="Typo.h6" Style="margin-left: 8px;">@(item.Text.Length > 20 ? item.Text.Substring(0, 20) + "..." : item.Text)</MudLink>
			</MudTooltip>
		</div>
	</ItemTemplate>
</MudBreadcrumbs>
</MudPaper>

<MudPaper Class="pa-4 mb-5 align-start d-flex" Style="width: auto" Outlined="false">
	<MudText Typo="Typo.h6" Align="Align.Left">Itemz</MudText>
</MudPaper>

<MudGrid>
	@if (initializingPage)
	{
		<MudPaper Height="calc(100vh - 100px);" Width="100%">
			<MudOverlay Visible="@initializingPage" DarkBackground="true" Absolute="true">
				<MudText Typo="Typo.h4" Align="Align.Center" Color="Color.Inherit">Loading ...</MudText>
				<br />
				<MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
			</MudOverlay>
		</MudPaper>
	}
	else
	{
 		<MudItem xs="12" sm="12">
			<MudPaper Class="pa-4 mb-5">
			<MudCard style="background-color : #FABBBB;" >
				<MudCardContent>
					<MudItem Class="pa-1 align-start d-flex" Style="width: auto" Outlined="false">
						<MudText Typo="Typo.h5" Align="Align.Left"><strong>@singleItemz.Name </strong></MudText>
						<MudSpacer />
						<MudButton OnClick="async _ => await editItemzDetails(ItemzId.ToString())" Variant="Variant.Filled" Size="Size.Medium" Color="Color.Success"> Edit Itemz </MudButton>
						<MudButton OnClick="goBackToParent" Variant="Variant.Filled" Size="Size.Medium" Color="Color.Warning" style="gap: 10px; margin-left : 10px"> Go Back </MudButton>
						</MudItem>
					<MudDivider Style="color: darkgray background-color: white; border-width: 2px; border-color: black; height: 2px; " />
					<br />
					<MudText><strong>ID          : </strong> @singleItemz.Id.ToString()</MudText>
					<MudText><strong>Status      : </strong> @singleItemz.Status</MudText>
					<MudText><strong>Priority    : </strong> @singleItemz.Priority</MudText>
					<MudText><strong>Severity    : </strong> @singleItemz.Severity</MudText>
					<MudText><strong>Description : </strong> @singleItemz.Description</MudText>
				</MudCardContent>
			</MudCard>
			</MudPaper>
		</MudItem>
 		<MudItem xs="12" sm="12">
			<MudPaper Class="pa-4 mb-5 align-start d-flex" Style="width: auto" Outlined="false">
				<MudText Typo="Typo.h6" Align="Align.Left">Child Itemz</MudText>
				<MudSpacer />
				<MudButton @onclick="async _ => await createNewItemz(ItemzId.ToString())" Variant="Variant.Filled" Size="Size.Medium" Color="Color.Primary"> Create Itemz </MudButton>
			</MudPaper>
			<MudText Class="pa-3 mb-5">Total number of Child Itemz : @AllChildItemz.Count() </MudText>
			<MudDataGrid Items="@AllChildItemz" 
						Filterable="true" 
						SortMode="@SortMode.None" 
						Groupable="false" 
						Striped="true" 
						FixedHeader="true" 
						HeaderClass="background-color: red;">
				<Columns>
					<PropertyColumn Property="x => x.RecordId" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
					<PropertyColumn Property="x => x.Name" />
					<PropertyColumn Property="x => x.NumberOfChildNodes" Title="Number of Child Itemz" Filterable="false" CellStyle="max-width: 100px; overflow-x: visible; white-space: normal; " />
 					<TemplateColumn CellClass="d-flex justify-left" >
						<CellTemplate>
							<MudButton Size="@Size.Large"
								Variant="@Variant.Filled" Color="@Color.Success"
									   OnClick="_ => openItemz(context.Item.RecordId.ToString())"> Open </MudButton>
						</CellTemplate>
					</TemplateColumn>
				</Columns>
			</MudDataGrid>
 		</MudItem>
	}
</MudGrid>
@code {
	[Parameter]
	public Guid ItemzId { get; set; }

	[Inject]
	public IItemzService itemzService { get; set; }
	// [Inject]
	// public IItemzTypeItemzsService itemzTypeItemzsService { get; set; }
	[Inject]
	public IHierarchyService HierarchyService { get; set; }


	public GetItemzDTO singleItemz { get; set; } = new();
	private List<HierarchyIdRecordDetailsDTO> AllChildItemz { get; set; } = new List<HierarchyIdRecordDetailsDTO>();
	private List<NestedHierarchyIdRecordDetailsDTO> AllParentHierarchy { get; set; } = new List<NestedHierarchyIdRecordDetailsDTO>();

	public bool initializingPage { get; set; } = true;

	private List<BreadcrumbItem> _localBreadcrumbs = new List<BreadcrumbItem>();
	// private NestedHierarchyIdRecordDetailsDTO _foundProjectRecord { get; set; }
	// private NestedHierarchyIdRecordDetailsDTO _foundItemzTypeRecord { get; set; }

	// protected override async Task OnInitializedAsync()
	// {

	// }

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			initializingPage = true;
			StateHasChanged();
			//Thread.Sleep(300);
			singleItemz = await itemzService.__Single_Itemz_By_GUID_ID__Async(ItemzId);

			//var returnedItemzList = await itemzTypeItemzsService.__GET_Itemzs_By_ItemzType__Async(ItemzTypeId,1,25,"Name");
			var returnedItemzList = await HierarchyService.__Get_Immediate_Children_Hierarchy_By_GUID__Async(ItemzId);

			if (returnedItemzList != null)
			{
				AllChildItemz = returnedItemzList.ToList();
			}

			initializingPage = false;

			var returnedParentHierarchyList = await HierarchyService.__Get_All_Parents_Hierarchy_By_GUID__Async(ItemzId);

			if (returnedParentHierarchyList != null)
			{
				AllParentHierarchy = returnedParentHierarchyList.ToList();
			}


			foreach (var tempParentHierarchyRecord in AllParentHierarchy)
			{
				var _tempHref = GetHREFForBreadcrumbs(
					breadcrumRecordType: tempParentHierarchyRecord.RecordType,
					breadcrumRecordId: tempParentHierarchyRecord.RecordId);
				var _tempIcon = GetIconForBreadcrumbs(tempParentHierarchyRecord.RecordType);

				_localBreadcrumbs.Add(new BreadcrumbItem

					(text: tempParentHierarchyRecord.Name
						, href: _tempHref
						, icon: _tempIcon)
					);
				if (tempParentHierarchyRecord.Children.Count > 0)
				{
					AddChildBreadcrumbs(tempParentHierarchyRecord.Children);
				}
			}

			// EXPLANATION :: Add self to breadcrums

			_localBreadcrumbs.Add(new BreadcrumbItem
						(
							text: singleItemz.Name
							, href: GetHREFForBreadcrumbs(
										breadcrumRecordType: "itemz", // TODO :: USE CONSTANTS
										breadcrumRecordId: singleItemz.Id)
							, icon: GetIconForBreadcrumbs("itemz") // TODO :: USE CONSTANTS
						)
				);



			// var matchingProjectRecord = FindRecordUsingLambda(AllParentHierarchy, recordType: "Project", level: 1);

			// if (matchingProjectRecord != null)
			// {
			// 	_foundProjectRecord = matchingProjectRecord;
			// }

			// var matchingItemzTypeRecord = FindRecordUsingLambda(AllParentHierarchy, recordType: "ItemzType", level: 2);

			// if (matchingItemzTypeRecord != null)
			// {
			// 	_foundItemzTypeRecord = matchingItemzTypeRecord;
			// }

			StateHasChanged();
			//StateHasChanged();
		}
	}

	#region Breadcrumbs_helper

	private void ForceReload(MouseEventArgs e, string uri)
	{
		if (!e.CtrlKey && !string.IsNullOrEmpty(uri))
		{
			NavManager.NavigateTo(uri, forceLoad: true);
		}
	}

	private void AddChildBreadcrumbs(List<NestedHierarchyIdRecordDetailsDTO> tempChildHierarchyRecords)
	{
		foreach (var _tempChildHierarchyRecord in tempChildHierarchyRecords)
		{
			var _tempHref = GetHREFForBreadcrumbs(
							breadcrumRecordType: _tempChildHierarchyRecord.RecordType,
							breadcrumRecordId: _tempChildHierarchyRecord.RecordId);
			var _tempIcon = GetIconForBreadcrumbs(_tempChildHierarchyRecord.RecordType);

			_localBreadcrumbs.Add(new BreadcrumbItem

				(text: (
								(_tempChildHierarchyRecord.Name.Length < 31)
								? _tempChildHierarchyRecord.Name
								: _tempChildHierarchyRecord.Name.Substring(0, 30)
						)
					, href: _tempHref
					, icon: _tempIcon)
				);
			if (_tempChildHierarchyRecord.Children.Count > 0)
			{
				AddChildBreadcrumbs(_tempChildHierarchyRecord.Children);
			}
		}
	}




	private string GetHREFForBreadcrumbs(string breadcrumRecordType, Guid breadcrumRecordId)
	{
		string _tempUrl =
			breadcrumRecordType.ToLower() switch
			{
				"project" => "http://localhost:5166/project/"
				,
				"itemztype" => "http://localhost:5166/itemzType/"
				,
				"itemz" => "http://localhost:5166/itemz/"
				,
				_ => string.Empty
			};

		_tempUrl = _tempUrl + breadcrumRecordId.ToString();
		return _tempUrl;
	}

	private string GetIconForBreadcrumbs(string breadcrumRecordType)
	{
		return
			breadcrumRecordType.ToLower() switch
			{
				"project" => Icons.Material.Filled.LocalFlorist
				,
				"itemztype" => Icons.Material.Filled.MenuBook
				,
				"itemz" => Icons.Material.Filled.Stream
				,
				_ => Icons.Material.Filled.Cancel
			};

	}

	#endregion

	public async Task editItemzDetails(string itemzId)
	{
		NavManager.NavigateTo($"/itemzDetails/{itemzId}");
	}

	public async Task createNewItemz(string itemzTypeId)
	{
		NavManager.NavigateTo($"/CreateItemz/{itemzTypeId}");
	}

	public async Task openItemz(string itemzId)
	{
		NavManager.NavigateTo($"/itemz/{itemzId}",true);
	}


	public async Task goBackToParent()
	{
		// TODO: IT COULD BE ITEMZ OR ITEMZTYPE AS PARENT OF A GIVEN ITEMZ.

		// EXPLANATION : At the start of initialization process we capture parent record ID.
		// Now even if user decides to Delete this Itemz Record then also we can go back to it's
		// Parent ItemzType post completing deletion operation.
		var httpResponse = await HierarchyService.__Get_Hierarchy_Record_Details_By_GUID__Async(ItemzId);

		if (httpResponse.ParentRecordType.ToLower() == "itemztype")
		{
			NavManager.NavigateTo($"/itemztype/{httpResponse.ParentRecordId.ToString()}",true);
		}
		else if (httpResponse.ParentRecordType.ToLower() == "itemz")
		{
			NavManager.NavigateTo($"/itemz/{httpResponse.ParentRecordId.ToString()}",true);
		}
	}

	#region Finding_Record_In_Parent_Hierarchy_Nodes

	public NestedHierarchyIdRecordDetailsDTO? FindRecordUsingLambda(List<NestedHierarchyIdRecordDetailsDTO> hierarchy, string recordType, int level)
	{
		return hierarchy
			.SelectMany(parent => GetAllRecords(parent))
			.FirstOrDefault(record => record.RecordType == recordType && record.Level == level);
	}

	private IEnumerable<NestedHierarchyIdRecordDetailsDTO> GetAllRecords(NestedHierarchyIdRecordDetailsDTO parent)
	{
		yield return parent;
		if (parent.Children != null)
		{
			foreach (var child in parent.Children.SelectMany(GetAllRecords))
			{
				yield return child;
			}
		}
	}
	#endregion
}
